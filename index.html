<!DOCTYPE html>
<html class="fill">
<head>
  <title>Favor for Fire Fighter</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
    integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
    crossorigin=""/>
<style>
.fill {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}
</style>
</head>
<body class="fill">
  <div id="mapid" class="fill"></div>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
    integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
    crossorigin="">
  </script>
  <script src="lib/heatmap.min.js"></script>
  <script src="lib/leaflet-heatmap.js"></script>

  <!-- D3たち -->
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="https://d3js.org/d3-random.v1.min.js"></script>
  <script src="https://d3js.org/d3-path.v1.min.js"></script>
  <script src="https://d3js.org/d3-shape.v1.min.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
  <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
  <script src="https://d3js.org/d3-ease.v1.min.js"></script>
  <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
  <script src="https://d3js.org/d3-selection.v1.min.js"></script>
  <script src="https://d3js.org/d3-timer.v1.min.js"></script>
  <script src="https://d3js.org/d3-transition.v1.min.js"></script>
  <script>
    // 地図作成
    var map = L.map('mapid').setView([20, 101], 8);

    // 一番下にmapbox表示
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 20,
        minZoom: 6,
        id: 'mapbox.emerald',
        accessToken: 'pk.eyJ1IjoidW9rdW11cmEiLCJhIjoiY2oyMzl1eGd5MDAwdjMzbGxwNGZoaWplaCJ9.PKXmdbEBSwShnDD3ZIMKkw'
    }).addTo(map);

    // ヒートマップを乗せてデータ読み込み
    createHeatmapLayerInto(map).loadData("data/fire.json");
    createWindLayerInto(map).loadData('data/fire.json', "data/wind.json");

    function createHeatmapLayerInto(map) {
      var heatmapLayer = new HeatmapOverlay(cfg = {
        radius: 0.01,
        maxOpacity: 400,
        minOpacity: 300,
        scaleRadius: true,
        useLocalExtrema: true,
        gradient: { 0.1: '#900', 0.25: '#f96', 0.5: '#fd9', 0.75: '#ffd', 1: "white" }
      }).addTo(map);

      return {
        heatmapLayer: heatmapLayer,
        loadData: function(path) {
          $.getJSON(path, function(data) {
            heatmapLayer.setData({"max": 400, "data": data});
          });
        }
      };
    };

    function createWindLayerInto(map) {
      var svgLayer = d3.select(map.getPanes().overlayPane).append('svg');
      svgLayer.attr('class', 'leaflet-zoom-hide fill');
      var plotLayer = svgLayer.append('g');

      var timers = []

      return {
        svgLayer: svgLayer,
        plotLayer: plotLayer,
        loadData: function(fireData, windData) {
          function reset() {
            timers.forEach(function(timer) { clearInterval(timer); });
            timers = [];
            this.loadData(fireData, windData);
          }

          map.on("zoomend", function() {
            this.reset();
          });
          map.on("moveend", function() {
            this.reset();
          });

          $.getJSON(windData, function(wind) {
            $.getJSON(fireData, function(data) {
              data.forEach(function(fire) {
                var pos = map.latLngToLayerPoint(new L.LatLng(fire.lat, fire.lng));
                var interval = fire.value > 400 ? 10 : fire.value > 300 ? 4000 - fire.value*10 : 1000


                var size = 10;
                var rect = {left:pos.x-size, top: pos.y-size, right:pos.x + size, bottom:pos.y+size}

                // 風速: ダミー
                var windDir = wind[0].data[(90-Math.round(fire.lat))*360 + Math.round(fire.lng)];
                var v = {
                  x:Math.cos(windDir * Math.PI / 180)*50,
                  y:Math.sin(windDir * Math.PI / 180)*50
                };

                timers.push(setInterval(
                  function() {
                    putParticle(svgLayer,
                      d3.randomUniform(rect.left, rect.right),
                      d3.randomUniform(rect.top, rect.bottom),
                      v.x, v.y
                    );
                  },
                  interval
                ));
              });
            });
          });
        }
      }
    }

    function putParticle(svgLayer, x, y, vx, vy) {

      var circle = svgLayer.append("circle")
        .attr("cx", x)
        .attr("cy", y)
        .attr("r", 2)
        .attr("fill", "#ffb")
        .attr("stroke", "#fb9")
        .attr("class", "particle");

      circle.transition()
        .duration(1000)
        .ease(d3.easeLinear)
        .attr("transform", "translate(" + vx + "," + vy + ")")
        .on('end', function () {
          d3.select(this).remove();
        });
      }

  </script>
</body>
</html>
